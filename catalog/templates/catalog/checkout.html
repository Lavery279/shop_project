{% extends "catalog/base.html" %}
{% block content %}
<div class="container mx-auto px-6">
    <h1 class="font-display text-4xl md:text-4xl font-medium text-foreground mb-8 text-center">
        Оформлення замовлення
    </h1>

    {% if messages %}
    <div id="toast-container" class="fixed top-6 right-6 space-y-2 z-50">
        {% for message in messages %}
        <div class="p-4 rounded-md font-body shadow-lg
                    {% if message.tags == 'error' %} bg-red-600 text-white
                    {% else %} bg-green-600 text-white {% endif %}">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}


    <form method="post" class="max-w-5xl mx-auto">
        {% csrf_token %}
        <div class="grid lg:grid-cols-3 gap-8">
            <!-- Contact Info -->
            <div class="lg:col-span-2 space-y-8">
                <div class="bg-card p-6 border border-border rounded-lg">
                    <h2 class="font-display text-xl font-medium text-foreground mb-6">Контактні дані</h2>
                    <div class="grid sm:grid-cols-2 gap-4">
                        <div class="space-y-2">
                            <label for="first_name" class="font-body">Ім'я</label>
                            <input type="text" name="first_name" id="first_name"
                                class="font-body w-full border rounded p-2" required>
                        </div>
                        <div class="space-y-2">
                            <label for="last_name" class="font-body">Прізвище</label>
                            <input type="text" name="last_name" id="last_name"
                                class="font-body w-full border rounded p-2" required>
                        </div>
                        <div class="space-y-2">
                            <label for="phone" class="font-body">Телефон</label>
                            <input type="text" name="phone" id="phone"
                                class="font-body w-full border rounded p-2"
                                placeholder="+380 __-___-____" required>
                            <script>
                                const phoneInput = document.getElementById('phone');

                                phoneInput.addEventListener('input', function (e) {
                                    let digits = e.target.value.replace(/\D/g, '');

                                    // якщо користувач вже ввів 380 — прибираємо його
                                    if (digits.startsWith('380')) {
                                        digits = digits.slice(3);
                                    }

                                    // обмежуємо до 9 цифр після 380
                                    digits = digits.slice(0, 9);

                                    // формуємо формат: +380 XX-XXX-XXXX
                                    let formatted = '+380 ';
                                    if (digits.length > 0) formatted += digits.slice(0, 2);
                                    if (digits.length > 2) formatted += '-' + digits.slice(2, 5);
                                    if (digits.length > 5) formatted += '-' + digits.slice(5, 9);

                                    e.target.value = formatted;
                                });

                                // блокуємо видалення префікса
                                phoneInput.addEventListener('keydown', function (e) {
                                    if (phoneInput.selectionStart < 5 && (e.key === 'Backspace' || e.key === 'Delete')) {
                                        e.preventDefault();
                                    }
                                });
                            </script>

                            {% if form.phone.errors %}
                            <div class="text-red-700 text-sm">
                                {% for error in form.phone.errors %}
                                {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        <div class="space-y-2">
                            <label for="email" class="font-body">Email</label>
                            <input type="email" name="email" id="email" class="font-body w-full border rounded p-2"
                                placeholder="example@email.com" required>
                                {% if form.email.errors %}
                                <div class="text-red-700 text-sm">
                                    {% for error in form.email.errors %}
                                    {{ error }}
                                    {% endfor %}
                                </div>
                                {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Delivery -->
                <div class="bg-card p-6 border border-border rounded-lg">
                    <h2 class="font-display text-xl font-medium text-foreground mb-6">Доставка</h2>
                    <div class="space-y-3 mb-6">
                        <label class="flex items-center space-x-3 p-3 border border-border rounded-lg cursor-pointer">
                            <input type="radio" name="delivery_method" value="nova-poshta" required>
                            <span class="font-body flex-1">Нова Пошта (відділення)</span>
                        </label>
                        <label class="flex items-center space-x-3 p-3 border border-border rounded-lg cursor-pointer">
                            <input type="radio" name="delivery_method" value="courier">
                            <span class="font-body flex-1">Кур'єрська доставка</span>
                        </label>
                    </div>

                    <div class="grid sm:grid-cols-2 gap-4">
                        <div class="space-y-2">
                            <label for="city" class="font-body">Місто</label>
                            <input type="text" name="city" id="city" class="font-body w-full border rounded p-2"
                                required>
                        </div>
                        <div class="space-y-2">
                            <label for="address" class="font-body">Адреса / Відділення</label>
                            <input type="text" name="address" id="address" class="font-body w-full border rounded p-2"
                                required>
                        </div>
                    </div>
                </div>

                <!-- Payment -->
                <div class="bg-card p-6 border border-border rounded-lg">
                    <h2 class="font-display text-xl font-medium text-foreground mb-6">Оплата</h2>
                    <div class="space-y-3">
                        <label class="flex items-center space-x-3 p-3 border border-border rounded-lg cursor-pointer">
                            <input type="radio" name="payment_method" value="card" required>
                            <span class="font-body flex-1">Оплата карткою онлайн</span>
                        </label>
                        <label class="flex items-center space-x-3 p-3 border border-border rounded-lg cursor-pointer">
                            <input type="radio" name="payment_method" value="cash">
                            <span class="font-body flex-1">Накладений платіж</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Order Summary -->
            <div class="lg:col-span-1">
                <div class="bg-card p-6 border border-border rounded-lg sticky top-24">
                    <h2 class="font-display text-xl font-medium text-foreground mb-4">Ваше замовлення</h2>

                    <div class="space-y-3 mb-6">
                        {% for item in cart %}
                        <div class="flex gap-3">
                            <img src="{{ item.product.image.url }}" alt="{{ item.product.title }}"
                                class="w-12 h-12 object-cover rounded" style="width: 3rem; height: 3rem;" />
                            <div class="flex-1 min-w-0">
                                <p class="font-body text-sm text-foreground truncate">{{ item.product.title }}
                                </p>
                                <p class="font-body text-xs text-muted-foreground">
                                    {{ item.quantity }} × {{ item.product.price }} ₴
                                </p>
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                    <div class="border-t border-border pt-4 space-y-2">
                        <div class="flex justify-between font-body text-sm">
                            <span class="text-muted-foreground">Товари</span>
                            <span>{{ cart_total }} ₴</span>
                        </div>
                        <div class="flex justify-between font-body text-sm">
                            <span class="text-muted-foreground">Доставка</span>
                            <span>Безкоштовно</span>
                        </div>
                        <div class="border-t border-border pt-2">
                            <div class="flex justify-between font-body font-medium text-lg">
                                <span>Разом</span>
                                <span class="text-primary">{{ cart_total }} ₴</span>
                            </div>
                        </div>
                    </div>

                    <button type="submit"
                        class="w-full mt-6 font-body bg-amber-600 text-primary-foreground py-3 rounded-lg hover:bg-amber-700 transition-colors">
                        Підтвердити замовлення
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}